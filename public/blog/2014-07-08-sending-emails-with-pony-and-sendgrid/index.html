<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Sending emails with Pony and Sendgrid &middot; Larry Price </title>

  
  <link rel="stylesheet" href="http://localhost:1313//css/poole.css">
  <link rel="stylesheet" href="http://localhost:1313//css/syntax.css">
  <link rel="stylesheet" href="http://localhost:1313//css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Larry Price" />
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>Larry Price</h1>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
    </ul>

    <p>&copy; 2015. All rights reserved. </p>
  </div>
</div>


    <div class="content container">
<div class="post">
  <h1>Sending emails with Pony and Sendgrid</h1>
  <span class="post-date">Tue, Jul 8, 2014</span>
      

<p>It&rsquo;s incredible how easy it is to send emails through a web application, there&rsquo;s no wonder we get so much spam. Assuming we have a <a href="http://ruby-lang.org">ruby</a> app using <a href="http://sinatrarb.com">Sinatra</a>, <a href="http://adam.herokuapp.com/past/2008/11/2/pony_the_express_way_to_send_email_from_ruby/">Pony</a> is one of the easiest ways to get started with your own spam empire.</p>

<p>Installation is, as always, trivial with ruby. Install the gem with <code>gem install pony</code> or add <code>gem pony</code> to your <code>Gemfile</code> and run <code>bundle install</code>.</p>

<p>I like to configure Pony in my application&rsquo;s <code>configure</code> block. I could also add it to my <code>config.ru</code>, but I like to keep that file as tiny as posible to avoid having configuration code all over the place.</p>

<p>``` ruby web.rb</p>

<h1 id="toc_0:5ab344014f78a7ee40372e0a19955ec4">&hellip;</h1>

<p>require &lsquo;pony&rsquo;
require &lsquo;sinatra/base&rsquo;</p>

<p>class Application &lt; Sinatra::Base
  configure do
    # &hellip;</p>

<pre><code>Pony.options = {
  :via =&gt; :smtp,
  :via_options =&gt; {
    :address =&gt; 'smtp.sendgrid.net',
    :port =&gt; '587',
    :domain =&gt; 'myapp.com',
    :user_name =&gt; ENV['SENDGRID_USERNAME'],
    :password =&gt; ENV['SENDGRID_PASSWORD'],
    :authentication =&gt; :plain,
    :enable_starttls_auto =&gt; true
  }
}
</code></pre>

<p>end</p>

<p># &hellip;
end</p>

<pre><code>
This block tells Pony to use the [SendGrid](http://sendgrid.com/) server to send mail, use the &quot;myapp.com&quot; HELO domain, and dig up the username and password fields from my environment.

If you're using [Heroku](https://heroku.com) to host your application, you can [sign up for a SendGrid account through your Heroku app](https://addons.heroku.com/sendgrid), which gives you instant access to your SendGrid account. The `username` and `password` field you need to fill in your environment are automatically populated in your Heroku config, which you can view by running `heroku config` for your application. The free account gets you up to 200 emails a day.

Since I might have multiple developers working in my source code and testing the email-sending functionality, I have all the developers [sign up for their own free SendGrid account](https://sendgrid.com/user/signup). This should help to alleviate some of the email volume from any particular account while developing. After signing up, it took my account nearly 4 hours to be &quot;provisioned&quot; (see: approved) by the SendGrid team. Once you're approved you can start sending emails using your developer account credentials. I stick my username/password in my local `.env` file (another reason to make sure you're not storing your environment on your server or in your git repo).

So let's actually send an email. Let's create a route that sends an email to verify a new user account; I'll take some liberties by saying we have a `User` model defined already that generates a signup verification hash. I can tell pony to send a plaintext body through the `body` option and an HTML body through the `html_body` option.

``` ruby web.rb
# ...
post '/signup' do
  user = User.create! params

  url = &quot;#{request.base_url}/account/reset/#{user.generate_verification_hash}&quot;
  Pony.mail(
    to: user.email,
    from: &quot;MyApp Help Desk &lt;noreply@myapp.com&gt;&quot;,
    subject: &quot;MyApp Account Verification&quot;,
    body: &quot;A request has been made to verify your MyApp account (https://myapp.com).&quot; +
          &quot;If you made this request, go to &quot; + url + &quot;. If you did not make this request, ignore this email.&quot;,
    html_body: haml(
      :verify_account_email,
      layout: false,
      locals: {
        email: user.email,
        date: DateTime.now.strftime(&quot;%H:%M:%S%P %B %d, %Y&quot;),
        ip: request.ip,
        url: url
      }
    )
  )
end
</code></pre>

<p>``` haml views/verify_account_email.rb
%p
  Hello!
%p
  An account verification has been requested for your new <a href="https://myapp.com">MyApp</a> account.</p>

<p>%ul
  %li
    Username: #{locals[:email]}
  %li
    Time: #{locals[:date]}
  %li
    IP address: #{locals[:ip]}</p>

<p>%p
  If you made this request, click the link below or copy-paste the following URL into your browser to verify your account:</p>

<p>%p
  %a{href: &ldquo;#{locals[:url]}&ldquo;, alt: &ldquo;Verify&rdquo;, title: &ldquo;Click to verify account&rdquo;}
    #{locals[:url]}</p>

<p>%p
  If you did not request this new account, please ignore this email.</p>

<p>%p
  Sincerely,
  %br
  Team MyApp</p>

<p>%p
  This email account is not monitored and will not receive replies. For more information, contact <a href="mailto:connect@myapp.com">connect@myapp.com</a>.
```</p>

<p>When you have a user hit this route, an email will be sent to the user with the given subject, to, from, and body fields using the configuration parameters given in the previous <code>configure</code> block. Fast, easy, and, best of all, no <code>sendmail</code> configuration.</p>

</div>
</div>

  <script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>
