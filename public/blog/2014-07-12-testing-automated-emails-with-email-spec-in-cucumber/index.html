<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Testing automated emails with email-spec in Cucumber &middot; Larry Price </title>

  
  <link rel="stylesheet" href="http://localhost:1313//css/poole.css">
  <link rel="stylesheet" href="http://localhost:1313//css/syntax.css">
  <link rel="stylesheet" href="http://localhost:1313//css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Larry Price" />
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>Larry Price</h1>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
    </ul>

    <p>&copy; 2015. All rights reserved. </p>
  </div>
</div>


    <div class="content container">
<div class="post">
  <h1>Testing automated emails with email-spec in Cucumber</h1>
  <span class="post-date">Sat, Jul 12, 2014</span>
      

<p>Now that <a href="/blog/2014/07/08/sending-emails-with-pony-and-sendgrid/">I send emails using Pony</a>, I want to be able to verify that the emails are being generated correctly. I also don&rsquo;t want to send real emails and have my tests check an inbox somewhere. I found a couple of solutions to do this, including <a href="https://github.com/johnmendonca/pony-test">pony-test</a> and <a href="https://github.com/bmabey/email-spec">email-spec</a>. Although pony-test fits my needs perfectly, the last commit was December 27, 2011 (2.5 years ago at the time of this post), and thus was using an outdated version of <a href="https://github.com/jnicklas/capybara">capybara</a> which I was unwilling to use. Fortunately, pony-spec is mostly just a fork of email-spec with all the non-Pony components ripped out.</p>

<p>I&rsquo;m going to be using Cucumber to test my emails, but email-spec also boasts compatibility with rspec and Turnip. To get started:</p>

<pre><code class="language-bash">$ gem install email-spec
</code></pre>

<p>The developers of email-spec were kind enough to give us some free step definitions. If I was using rails, I could just type <code>rails generate email_spec:steps</code>, but since I&rsquo;m using Sinatra I opted just to copy-paste the file into my <code>step_definitions/</code> directory. You can find <code>email_steps.rb</code> <a href="https://raw.githubusercontent.com/bmabey/email-spec/master/lib/generators/email_spec/steps/templates/email_steps.rb">on Github</a>.</p>

<p>In <a href="/blog/2014/07/08/sending-emails-with-pony-and-sendgrid/">my last post about small horses and emails</a>, I used the following code to send a confirmation email on signup:</p>

<p>``` ruby web.rb</p>

<h1 id="toc_0:fc24f51bf0f4b159a20fecc6f3770b7e">&hellip;</h1>

<p>post &lsquo;/signup&rsquo; do
  user = User.create! params</p>

<p>url = &ldquo;#{request.base_url}/account/reset/#{user.generate_verification_hash}&rdquo;
  Pony.mail(
    to: user.email,
    from: &ldquo;MyApp Help Desk <a href="mailto:noreply@myapp.com">noreply@myapp.com</a>&rdquo;,
    subject: &ldquo;MyApp Account Verification&rdquo;,
    body: &ldquo;A request has been made to verify your MyApp account (<a href="https://myapp.com).&quot;">https://myapp.com).&quot;</a> +
          &ldquo;If you made this request, go to &rdquo; + url + &ldquo;. If you did not make this request, ignore this email.&rdquo;,
    html_body: haml(
      :verify_account_email,
      layout: false,
      locals: {
        email: user.email,
        date: DateTime.now.strftime(&ldquo;%H:%M:%S%P %B %d, %Y&rdquo;),
        ip: request.ip,
        url: url
      }
    )
  )
end</p>

<h1 id="toc_1:fc24f51bf0f4b159a20fecc6f3770b7e">&hellip;</h1>

<pre><code>
``` haml /views/verify_account_email.haml
%p
  Hello!
%p
  An account verification has been requested for your new &lt;a href=&quot;https://myapp.com&quot;&gt;MyApp&lt;/a&gt; account.

%ul
  %li
    Username: #{locals[:email]}
  %li
    Time: #{locals[:date]}
  %li
    IP address: #{locals[:ip]}

%p
  If you made this request, click the link below or copy-paste the following URL into your browser to verify your account:

%p
  %a{href: &quot;#{locals[:url]}&quot;, alt: &quot;Verify&quot;, title: &quot;Click to verify account&quot;}
    #{locals[:url]}

%p
  If you did not request this new account, please ignore this email.

%p
  Sincerely,
  %br
  Team MyApp

%p
  This email account is not monitored and will not receive replies. For more information, contact &lt;a href=&quot;mailto:connect@myapp.com&quot;&gt;connect@myapp.com&lt;/a&gt;.
</code></pre>

<p>Given the pre-defined steps from email-spec, testing that this email gets sent is a breeze. Adding a scenario to my feature file:</p>

<p>``` cucumber features/SignupConfirmation.feature
Feature: Signup Confirmation
  As a new user
  When I sign up
  I should receive a confirmation email</p>

<p>Background:
  Given a clear email queue
  When I go to the signup page
  And I fill in &ldquo;email&rdquo; with &ldquo;prez@whitehouse.gov&rdquo;
  And I fill in &ldquo;password&rdquo; with &ldquo;bunnies&rdquo;
  And I press &ldquo;Sign Up&rdquo;
  Then &ldquo;prez@whitehouse.gov&rdquo; should receive an email</p>

<p>Scenario: Receives email with correct contents
  When &ldquo;prez@whitehouse.gov&rdquo; opens the email
  Then they should see the email delivered from &ldquo;MyApp Help Desk <a href="mailto:noreply@myapp.com">noreply@myapp.com</a>&ldquo;
  And they should see &ldquo;MyApp Account Verification&rdquo; in the email subject
  And they should see &ldquo;Username: prez@whitehouse.gov&rdquo; in the email body
  And they should see &ldquo;An account verification has been requested&rdquo;
```</p>

<p>That&rsquo;s it. Now we know that an email like the one above will be sent during signup. What we can&rsquo;t test here is that our SMTP server (or equivalent) is working, so in reality I&rsquo;m only testing that the email will attempt to send that looks like the one I test against.</p>

</div>
</div>

  <script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>
